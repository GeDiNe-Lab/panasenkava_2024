# Loading packages and functions
library(Matrix)
library(tidyverse)
library(ComplexHeatmap)
library(org.Hs.eg.db)
library(DESeq2)
library(Seurat)

# Setting working directory
rstudioapi::getSourceEditorContext()$path %>%
    str_split("/") %>%
    unlist() %>%
    head(-3) %>%
    str_c(collapse = "/") %>%
    str_c("/") %>%
    setwd()

# Loading custom functions
source("R/custom_fct.R")

# loading single cell data from Zeng et al from week3,week4 and week5
sc_counts <- readMM("scdata/week345_wholebody.mtx") %>% t()

# keeping only cells related to Central Nervous System (SNC)
cellids <- read.table("scdata/indices_week345_wholebody.csv", header = TRUE, sep = ",")
genes <- read.table("scdata/genes_week345_wholebody.tsv", header = FALSE)$V1

# set rownames
rownames(sc_counts) <- genes

# format and set colnames
formated_indices <- c(1:nrow(cellids)) %>% sapply(function(i) {
    c(str_split(cellids[i, ]$index, "-")[[1]][1:2], cellids[i, ]$week_stage) %>%
        paste(collapse = "-") %>%
        return()
})
colnames(sc_counts) <- formated_indices

sc_meta <- read.csv("scdata/week345_wholebody_metadata.csv") %>%
    filter(celltype_region_num %in% c(1:8)) %>%
    dplyr::select(c("week_stage", "celltype_region_num", "celltype_region", "barcode"))

View(sc_meta)
# seurat_weekAll <- CreateSeuratObject(counts = sc_counts, meta.data = sc_meta, min.cells = 20)
# seurat_weekAll <- NormalizeData(seurat_weekAll)

# seurat_weekAll <- FindVariableFeatures(seurat_weekAll, selection.method = "vst", nfeatures = 2000)
# seurat_weekAll <- ScaleData(seurat_weekAll, features = all.gerownames(seurat_weekAll)nes)
# seurat_weekAll <- RunPCA(seurat_weekAll, features = VariableFeatures(object = seurat_weekAll))
# seurat_weekAll <- RunUMAP(seurat_weekAll, dims = 1:10)

sc_meta_week3 <- filter(sc_meta, week_stage == "W3-1")
seurat_week3 <- CreateSeuratObject(counts = sc_counts[, sc_meta_week3$barcode], meta.data = sc_meta_week3, min.cells = 20)
seurat_week3 <- NormalizeData(seurat_week3)

seurat_week3 <- FindVariableFeatures(seurat_week3, selection.method = "vst", nfeatures = 2000)
seurat_week3 <- ScaleData(seurat_week3, features = rownames(seurat_week3))
seurat_week3 <- RunPCA(seurat_week3, features = VariableFeatures(object = seurat_week3))
seurat_week3 <- RunUMAP(seurat_week3, dims = 1:10)

umap_week3 <- seurat_week3[["umap"]]@cell.embeddings %>% as.data.frame()
sc_meta_week3 <- cbind(umap_week3[sc_meta_week3$barcode, ], sc_meta_week3)
View(sc_meta_week3)

sc_meta_week4 <- filter(sc_meta, week_stage == "W4-1")
seurat_week4 <- CreateSeuratObject(counts = sc_counts[, sc_meta_week4$barcode], meta.data = sc_meta_week4, min.cells = 20)
seurat_week4 <- NormalizeData(seurat_week4)

seurat_week4 <- FindVariableFeatures(seurat_week4, selection.method = "vst", nfeatures = 2000)
all.genes <- rownames(seurat_week4)
seurat_week4 <- ScaleData(seurat_week4, features = all.genes)
seurat_week4 <- RunPCA(seurat_week4, features = VariableFeatures(object = seurat_week4))
seurat_week4 <- RunUMAP(seurat_week4, dims = 1:10)

umap_week4 <- seurat_week4[["umap"]]@cell.embeddings %>% as.data.frame()
sc_meta_week4 <- cbind(umap_week4[sc_meta_week4$barcode, ], sc_meta_week4)


sc_meta_week5 <- filter(sc_meta, week_stage == "W5-1")
seurat_week5 <- CreateSeuratObject(counts = sc_counts[, sc_meta_week5$barcode], meta.data = sc_meta_week5, min.cells = 20)
seurat_week5 <- NormalizeData(seurat_week5)

seurat_week5 <- FindVariableFeatures(seurat_week5, selection.method = "vst", nfeatures = 2000)
all.genes <- rownames(seurat_week5)
seurat_week5 <- ScaleData(seurat_week5, features = all.genes)
seurat_week5 <- RunPCA(seurat_week5, features = VariableFeatures(object = seurat_week5))
seurat_week5 <- RunUMAP(seurat_week5, dims = 1:10)

umap_week5 <- seurat_week5[["umap"]]@cell.embeddings %>% as.data.frame()
sc_meta_week5 <- cbind(umap_week5[sc_meta_week5$barcode, ], sc_meta_week5)

View(as.data.frame(rownames(seurat_week3)))
View(as.data.frame(rownames(seurat_week4)))
View(as.data.frame(rownames(seurat_week5)))


marker_genes <- c("SHH", "NKX2-1", "CAPN6", "PAX6", "LINC00261", "CNTNAP2")

gc()
for (gene in marker_genes) {
    if (gene %in% rownames(seurat_week3)) {
        sc_meta_week3$expression <- seurat_week3@assays$RNA$scale.data[gene, sc_meta_week3$barcode]
        umap_plot <- ggplot(data = sc_meta_week3, aes(x = umap_1, y = umap_2, color = expression)) +
            geom_point(size = 1) +
            ggtitle(gene) +
            scale_color_gradient(low = "lightblue", high = "darkred") +
            custom_theme()
        ggsave(paste0("results/images/Figure_5/genes_umap_Zeng_week3_", gene, ".png"), plot = umap_plot, width = 14, height = 10, dpi = 300)
        gc()
    } else {
        print(paste0(gene, " not in week3"))
    }
}

gc()
for (gene in marker_genes) {
    if (gene %in% rownames(seurat_week4)) {
        sc_meta_week4$expression <- seurat_week4@assays$RNA$scale.data[gene, sc_meta_week4$barcode]
        umap_plot <- ggplot(data = sc_meta_week4, aes(x = umap_1, y = umap_2, color = expression)) +
            geom_point(size = 1) +
            ggtitle(gene) +
            scale_color_gradient(low = "lightblue", high = "darkred") +
            custom_theme()
        ggsave(paste0("results/images/Figure_5/genes_umap_Zeng_week4_", gene, ".png"), plot = umap_plot, width = 14, height = 10, dpi = 300)
        gc()
    } else {
        print(paste0(gene, " not in week4"))
    }
}

gc()
for (gene in marker_genes) {
    if (gene %in% rownames(seurat_week5)) {
        sc_meta_week5$expression <- seurat_week5@assays$RNA$scale.data[gene, sc_meta_week5$barcode]
        umap_plot <- ggplot(data = sc_meta_week5, aes(x = umap_1, y = umap_2, color = expression)) +
            geom_point(size = 1) +
            ggtitle(gene) +
            scale_color_gradient(low = "lightblue", high = "darkred") +
            custom_theme()
        ggsave(paste0("results/images/Figure_5/genes_umap_Zeng_week5_", gene, ".png"), plot = umap_plot, width = 14, height = 10, dpi = 300)
        gc()
    } else {
        print(paste0(gene, " not in week5"))
    }
}
